<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		
		<link href="../../../../_app/immutable/assets/0.CWEFMGw7.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/CodeBlockWrapper.DOA6KAmR.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/start.J4futHBO.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D7kvlzrP.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CVx5jffJ.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DIeogL5L.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DMgF1Uhx.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D0iwhpLH.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/ByF348JK.js">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/app.BUVMy7h9.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D_kqQSo5.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/2cXyNWGb.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Bzak7iHL.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Ca2j7qFz.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/BmVC6lTd.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/BnZK2-eX.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/C0t2u1D1.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/0.B7lyYr5v.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D7leeM5l.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DKQVeb5P.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CP-r3QU3.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Bp7YhWCs.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DkPbIObf.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/69_IOA4Y.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D2vXKg8d.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DJh_0fka.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Dg0EvQHI.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/12.Dr14LVIl.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DF2T1Nhr.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CxRPdVhl.js"><!--1y1qu0s--><meta data-key="description" name="description" content="Factories, Repositories, and Services"/> <meta property="og:type" content="article"/> <meta property="og:title" content="팩토리, 레포지토리, 서비스"/> <meta property="og:description" content="Factories, Repositories, and Services"/><!----><title>팩토리, 레포지토리, 서비스</title>
		<!-- You can replace this block to update the Google fonts used in the project -->
		<!-- <link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css"
		/>
		<link
			href="https://fonts.googleapis.com/css2?&family=Nanum+Gothic&family=Jua&family=Source+Code+Pro:wght@400&display=swap"
			rel="stylesheet"
		/>

		<!-- End Google Fonts block -->

		<!-- You can add global <meta> tags here, but anything not global or dynamic should be a `<svelte:head>` tag on the proper page(s) instead. -->
	</head>
	<body>
		<div id="svelte"><!--[--><!--[--><!----><div class="layout"><header><a class="skip-to-content-link" href="#main">Skip to main content</a> <nav class="main-nav"><ul><!--[--><li><a href="/posts" aria-current="false"><!---->Posts<!----></a></li><li><a href="/category" aria-current="false"><!---->Categories<!----></a></li><li><a href="/about" aria-current="false"><!---->About<!----></a></li><li><a href="/api/rss.xml" aria-current="false"><!---->RSS<!----></a></li><li><a href="/#" aria-current="false"><!---->Home<!----></a></li><!--]--></ul> <button aria-pressed="false" class="menu-button" tabindex="-1"><span class="sr-only">Toggle hamburger menu</span> <!--[--><svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M64,48.496l-48.496,-48.496l-15.504,15.504l48.496,48.496l-48.496,48.496l15.504,15.504l48.496,-48.496l48.496,48.496l15.504,-15.504l-48.496,-48.496l48.496,-48.496l-15.504,-15.504l-48.496,48.496Z"></path></svg><!--]--></button><!----></nav><!----> <button aria-pressed="false" class="menu-button" tabindex="0"><span class="sr-only">Toggle hamburger menu</span> <!--[!--><svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><rect x="0" y="12.48" width="128" height="18.688"></rect></g><g><rect x="0" y="96.832" width="128" height="18.688"></rect></g><g><rect x="0" y="54.656" width="128" height="18.688"></rect></g></svg><!--]--></button><!----> <a href="/" class="site-title">집밥서선생</a> <button class="toggle-theme"><!--[-->☀️<!--]--></button><!----></header><!----> <main id="main" tabindex="-1"><!----><div class="content"><!----><article class="post"><img class="cover-image" src="/post_img/Backend/Architecture/DDD/cover.png" alt="" style="aspect-ratio: 16 / 9;" width="16" height="9"/> <h1>팩토리, 레포지토리, 서비스</h1> <div class="meta"><b>Published:</b> 2023-07-16</div> <!----><h2 id="팩토리-패턴"><a aria-hidden="true" tabindex="-1" href="#팩토리-패턴"><span class="icon icon-link"></span></a>팩토리 패턴</h2> <hr/> <p>팩토리 패턴은 주로 객체지향 프로그래밍에서 찾아볼 수 있으며, 다른 오브젝트를 생성하는 주된 책임을 가지고 있는 개체로 정의된다.
객체의 기본 속성을 설정하는 데 유용하며, 일반적으로 객체의 생성 외에 다른 목적을 가지면 안된다.</p> <p>Go는 객체지향 언어가 아님에도 팩토리 패턴은 꽤 유용하다.
아래 예제는 팩토리 패턴의 간단한 예제이다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"errors"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"log"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Car <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">BeepBeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> BMW <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	heatedSeatSubscriptionEnabled <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>B BMW<span class="token punctuation">)</span> <span class="token function">BeepBeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// TODO: implement me</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> Tesla <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	autopilotEnabled <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>T Tesla<span class="token punctuation">)</span> <span class="token function">BeepBeep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// TODO: implement me</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">BuildCar</span><span class="token punctuation">(</span>carType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Car<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> carType <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token string">"bmw"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> BMW<span class="token punctuation">&#123;</span>heatedSeatSubscriptionEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token string">"tesla"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> Tesla<span class="token punctuation">&#123;</span>autopilotEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"unknown car type"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	myCar<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">BuildCar</span><span class="token punctuation">(</span><span class="token string">"tesla"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// TODO: do something with myCar</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v is my car&#92;n"</span><span class="token punctuation">,</span> myCar<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>위 예제에서는 <code>Car</code> 인터페이스를 충족하는 <code>BMW</code>와 <code>Tesla</code> 구조체를 정의하였고, <code>Car</code> 오브젝트의 필드값을 초기화하여 반환하는 팩토리 함수 <code>BuildCar</code>를 정의하였다.
또한, 자동차의 타입이 유효하지 않을 경우 에러를 반환한다.</p> <p>팩토리 패턴은 복잡한 구조체의 생성을 표준화하는 좋은 방법이며, 애플리케이션이 복잡해질 수록 유용하다.
또한 팩토리를 통해 Encapsulation을 달성할 수 있고, 객체 생성시 비즈니스 불변성을 적용하여 도메인 모델을 단순화할 수 있다.</p> <p>가령 미용실 예약 시스템을 구현한다고 가정해보자.
누군가 업무 시간이 지나고 예약하려 하는 경우, 다음과 같이 팩토리 함수를 통해 예외를 발생시킬 수 있다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token punctuation">(</span>
<span class="token string">"errors"</span>
<span class="token string">"github.com/google/uuid"</span>
<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Booking <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
id uuid<span class="token punctuation">.</span>UUID
userId uuid<span class="token punctuation">.</span>UUID
from time<span class="token punctuation">.</span>Time
to time<span class="token punctuation">.</span>Time
hairDresserId uuid<span class="token punctuation">.</span>UUID
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">CreateBooking</span><span class="token punctuation">(</span>from time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> to time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> userId uuid<span class="token punctuation">.</span>UUID<span class="token punctuation">,</span> hairDresserId uuid<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Booking<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
closingTime<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Kitchen<span class="token punctuation">,</span> <span class="token string">"17:00pm"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> from<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>closingTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"no appointments after closing time"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Booking<span class="token punctuation">&#123;</span>
    		hairDresserId<span class="token punctuation">:</span> hairDresserId<span class="token punctuation">,</span>
    		id<span class="token punctuation">:</span>            uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    		userId<span class="token punctuation">:</span>        userId<span class="token punctuation">,</span>
    		from<span class="token punctuation">:</span>          from<span class="token punctuation">,</span>
    		to<span class="token punctuation">:</span>            to<span class="token punctuation">,</span>
    	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
</code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>위 예제는 엔티티를 생성하는 팩토리 함수를 보여주며, 엔티티의 식별자는 팩토리에서 생성된다.</p> <p>엔티티 팩토리에 대헤 조금 더 살펴보자.</p> <br/> <h3 id="엔티티-팩토리"><a aria-hidden="true" tabindex="-1" href="#엔티티-팩토리"><span class="icon icon-link"></span></a>엔티티 팩토리</h3> <p>앞선 포스트에서 설명하였듯 엔티티에는 식별자가 있고, 인스턴스화하기 위한 최소한의 요구사항이 존재한다.
따라서 팩토리를 만들 때 이러한 요구사항을 충족시켜야 하며, 다른 속성을 설정하려는 경우 이를 위한 다른 함수를 제공할 수 있다.</p> <p>엔티티 팩토리 함수를 만들 때는 팩토리 함수가 식별자를 생성할지, 아니면 파라미터로 받을지 결정해야 한다.
둘 다 가능하지만, 되도록이면 식별자를 팩토리 함수에서 생성하는 것이 더 좋은 방법이다.</p> <br/><br/> <h2 id="레포지토리-패턴"><a aria-hidden="true" tabindex="-1" href="#레포지토리-패턴"><span class="icon icon-link"></span></a>레포지토리 패턴</h2> <hr/> <p>레포지토리 패턴은 데이터 저장소에 접근하기 위해 필요한 코드의 일부이다.
데이터 저장소는 파일 시스템, 메모리, 스프레드시트, S3 등이 있을 수 있으나, 대부분의 프로젝트에서는 데이터베이스에 해당한다.</p> <p>레포지토리 계층을 사용함으로써 데이터에 액세스하는 코드를 중앙화하여 관리할 수 있고, 특정 데이터베이스에 코드가 종속되지 않도록 할 수 있다.
예를 들면 한 클라우드에서 다른 클라우드로 마이그레이션하는 경우 데이터베이스 설정이 약간 달라질 수 있다. 이를테면 한 MySQL에서 NoSQL로 이동하는 경우이다.
이 경우 시스템의 일부분만, 즉 레포지토리 계층만 다시 설계하면 된다.</p> <p>일부 개발자는 다른 채널(CQRS: Command Query Responsibility Segregation 등)을 통해 데이터베이스에 쿼리를 보내는 것을 선호한다.
이는 쿼리가 데이터베이스의 상태를 변경하면 안되기 때문에 작동하지만, 이제 막 시작하는 경우라면 데이터베이스와의 모든 상호작용이 레포지토리 계층에서 일어나게 하는 것이 좋다.</p> <p>레포지토리 계층에서 테이블 하나당 한 개의 구조체를 만드는 경우가 많은데, 그보단 애그리거트당 하나의 구조체를 만드는 것이 더 좋다. 다음 그림을 보자.</p> <h3 id="그림"><a aria-hidden="true" tabindex="-1" href="#그림"><span class="icon icon-link"></span></a>그림</h3> <p>위 그림에서 데이터베이스 테이블과 레포지토리 계층의 명확한 차이를 볼 수 있다. 주목할 부분은 레포지토리 계층에서 한 개 이상의 테이블을 사용할 수 있다는 것이다.
또한, 도메인 레이어는 레포지토리 레이어와 디커플링되어 있다.
DDD를 사용한다면 위와 같은 시스템을 구축하는 것이 좋다.</p> <br/> <p>이전 장의 예약 시스템 예제에서 계속하여, 미용실 예약 정보를 데이터베이스에 저장하려 한다. 먼저 레포지토리 계층에 해당하는 인터페이스를 정의한다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token string">"context"</span>

<span class="token keyword">type</span> BookingRepository <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">SaveBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">DeleteBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>이 인터페이스는 <code>Booking</code> 팩토리 및 서비스 계층과 같은 계층에 정의되었는데, 그 이유는 다음 장에서 설명한다.</p> <p>PostgreSQL 데이터베이스를 위한 간단한 레포지토리 레이어를 구현해보자.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/jackc/pgx/v4"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> BookingRepository <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">SaveBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">DeleteBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> PostgresRepository <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	connPool <span class="token operator">*</span>pgx<span class="token punctuation">.</span>Conn
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">NewPostgresRepository</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> dbConnString <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PostgresRepository<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> pgx<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dbConnString<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to connect to database: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>PostgresRepository<span class="token punctuation">&#123;</span>connPool<span class="token punctuation">:</span> conn<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p PostgresRepository<span class="token punctuation">)</span> <span class="token function">SaveBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>connPool<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>
		ctx<span class="token punctuation">,</span>
		<span class="token string">"INSERT INTO bookings (id, from, to, hair_dresser_id) VALUES ($1, $2, $3, $4)"</span><span class="token punctuation">,</span>
		booking<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		booking<span class="token punctuation">.</span>from<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		booking<span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		booking<span class="token punctuation">.</span>hairDresserId<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to save booking: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p PostgresRepository<span class="token punctuation">)</span> <span class="token function">DeleteBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>connPool<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>
		ctx<span class="token punctuation">,</span>
		<span class="token string">"DELETE FROM bookings WHERE id = $1"</span><span class="token punctuation">,</span>
		booking<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to delete booking: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>코드에서 볼 수 있듯, 데이터베이스와 상호작용하는 것은 꽤 간단하며, 도메인 로직이 들어가지 않는다.
도메인 로직은 애플리케이션 서비스 계층에 들어가며, 애플리케이션 서비스 계층은 다음 장에서 다룬다.</p> <br/><br/> <h2 id="서비스-계층"><a aria-hidden="true" tabindex="-1" href="#서비스-계층"><span class="icon icon-link"></span></a>서비스 계층</h2> <hr/> <p>DDD에서 코드를 조직화하기 위해 몇 가지 종류의 서비스를 사용한다.
각각 애플리케이션 서비스, 도메인 서비스, 인프라스트럭처 서비스이다.</p> <br/> <h3 id="도메인-서비스"><a aria-hidden="true" tabindex="-1" href="#도메인-서비스"><span class="icon icon-link"></span></a>도메인 서비스</h3> <p>도메인 서비스는 도메인 내에서 특정 작업을 수행하는 stateless한 연산이다.
엔티티 혹은 밸류 오브젝트로 모델링하는 좋은 방법을 찾을 수 없는 프로세스가 있을 때가 있는데, 이 경우 도메인 서비스를 사용하면 좋다</p> <p>도메인 서비스의 규칙을 정의하기는 좀 애매한 감이 있지만, 주의해야 할 점이 있다.</p> <ul><li>작성되는 코드는 한 도메인 내에서 중요한 비즈니스 로직을 수행해야 한다.</li> <li>한 도메인 객체를 다른 도메인 객체로 변환한다.</li> <li>값을 계산하기 위해 두 개 이상의 도메인 객체의 속성을 사용한다.</li></ul> <p>서비스는 DDD의 다른 모든 요소들과 마찬가지로 제한된 컨텍스트 안에서 유비쿼터스 언어를 통해 표현되어야 한다.</p> <p>서비스가 유용하게 쓰일 수 있는 예제를 살펴보자. 엔티티 내에 이런 코드가 있다고 가정해보자.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token string">"github.com/google/uuid"</span>

<span class="token keyword">type</span> Product <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Id             uuid<span class="token punctuation">.</span>UUID
	InStock        <span class="token builtin">bool</span>
	InSomeonesCart <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p Product<span class="token punctuation">)</span> <span class="token function">CanBeBought</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>InStock <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>InSomeonesCart
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> ShoppingCart <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Id          uuid<span class="token punctuation">.</span>UUID
	Products    <span class="token punctuation">[</span><span class="token punctuation">]</span>Product
	IsFull      <span class="token builtin">bool</span>
	MaxCartSize <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ShoppingCart<span class="token punctuation">)</span> <span class="token function">AddToCard</span><span class="token punctuation">(</span>p Product<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>IsFull <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">CanBeBought</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>Products <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Products<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>MaxCartSize <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Products<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>IsFull <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>괜찮아 보이는 코드지만 문제가 있다. <code>ShoppingCart</code>의 구현에서 다른 엔티티를 참조하고 있고, 실제로 <code>ShoppingCart</code>에 속하지 않는 비즈니스 로직이 포함되어 있다.
이런 문제를 해결하기 위해 도메인 서비스를 사용할 수 있다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token string">"errors"</span>

<span class="token keyword">type</span> CheckOutService <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	shoppingCart <span class="token operator">*</span>ShoppingCart
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">NewCheckOutService</span><span class="token punctuation">(</span>shoppingCart <span class="token operator">*</span>ShoppingCart<span class="token punctuation">)</span> <span class="token operator">*</span>CheckOutService <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>CheckOutService<span class="token punctuation">&#123;</span>shoppingCart<span class="token punctuation">:</span> shoppingCart<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CheckOutService<span class="token punctuation">)</span> <span class="token function">AddProductToCart</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Product<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>IsFull <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"cannot add product to full cart"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">CanBeBought</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>Products <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>Products<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>MaxCartSize <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>Products<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>shoppingCart<span class="token punctuation">.</span>IsFull <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>두 엔티티에 모두 접근할 수 있는 도메인 로직이 도메인 서비스에 작성되었다.
이를 통해, <code>CheckOutService</code>에서 더 많은 엔티티를 참조하고자 할 때 더 유용해질 것이다.
단일 도메인 서비스에 이러한 로직이 있기 때문에, 다른 클라이언트에서 우리의 동작을 구현하려는 경우 이 서비스를 사용할 수 있으며, 비즈니스 불변성이 유지된다.</p> <p>도메인 서비스는 stateless하게 도메인 로직을 구성해야 하는 경우에 유용하다.
하지만 stateful한 로직을 구성해야 하는 경우에는 애플리케이션 서비스를 사용해야 한다.</p> <br/> <h3 id="애플리케이션-서비스"><a aria-hidden="true" tabindex="-1" href="#애플리케이션-서비스"><span class="icon icon-link"></span></a>애플리케이션 서비스</h3> <p>애플리케이션 서비스는 다른 서비스 및 레포지토리를 구성하는 데 사용되며, 여러 모달 사이에서 트랜잭션을 관리한다.
다만 도메인 로직은 애플리케이션 서비스가 아니라 도메인 서비스에 작성되어야 한다.</p> <p>어플리케이션 서비스는 보통 그렇게 길지 않다. 일반적으로 트랜잭션 등 조정을 위해 사용되며, 다른 로직은 어플리케이션 레이어 밑으로 내려가야 한다. 또한 보한 문제를 해결하기도 한다.</p> <p>예약 예제를 통해 애플리케이션 서비스를 살펴보자.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/jhseoeo/Golang-DDD/chapter2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> accountKey <span class="token operator">=</span> <span class="token builtin">int</span>

<span class="token keyword">const</span> accountCtxKey <span class="token operator">=</span> <span class="token function">accountKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> BookingDomainService <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">CreateBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> BookingAppService <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	bookingRepo          BookingRepository
	bookingDomainService BookingDomainService
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">NewBookingAppService</span><span class="token punctuation">(</span>bookingRepo BookingRepository<span class="token punctuation">,</span> bookingDomainService BookingDomainService<span class="token punctuation">)</span> <span class="token operator">*</span>BookingAppService <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>BookingAppService<span class="token punctuation">&#123;</span>
		bookingRepo<span class="token punctuation">:</span>          bookingRepo<span class="token punctuation">,</span>
		bookingDomainService<span class="token punctuation">:</span> bookingDomainService<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>BookingAppService<span class="token punctuation">)</span> <span class="token function">CreateBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	u<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>accountCtxKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>chapter2<span class="token punctuation">.</span>Customer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid customer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> u<span class="token punctuation">.</span><span class="token function">UserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> booking<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"cannot create booking for other users"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	err <span class="token operator">:=</span> b<span class="token punctuation">.</span>bookingDomainService<span class="token punctuation">.</span><span class="token function">CreateBooking</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> booking<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not create booking: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	err <span class="token operator">=</span> b<span class="token punctuation">.</span>bookingRepo<span class="token punctuation">.</span><span class="token function">SaveBooking</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> booking<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not save bookign: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>위 코드에서는 기본적인 인증을 수행하고, 도메인 레이어와 레포지토리 레이어로 애플리케이션 서비스를 구성한다.
이런 예제의 경우에서라면 애플리케이션 서비스가 여러 도메인에 걸쳐 있지 않기 때문에 영속성을 도메인 서비스에서 건드리는 것도 괜찮다.
이 코드가 실행되면 새로운 예약이 생성되고 저장된다.</p> <p>UI는 여러 도메인 서비스를 통해 구성될 필요가 있는데, 이런 측면에서 애플리케이션 서비스가 잘 어울린다.</p> <br/> <p>대부분의 최신 웹 앱은 결제, 이메인 전송, 유저 행동 추적 등의 역할을 수행한다.
이러한 기능들은 도메인에 포함되지는 않지만 여전히 애플리케이션에 포함되어야 한다.
이러한 경우 인프라스트럭처 레이어를 사용하여, 애플리케이션 서비스나 도메인 서비스에 추가할 수 있다.</p> <p>가령 이메일 인프라스트럭처 서비스는 다음과 같이 구현될 수 있다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">package</span> chapter4

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"context"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> EmailSender <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">SendEmail</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> to <span class="token builtin">string</span><span class="token punctuation">,</span> title <span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> emailUrl <span class="token operator">=</span> <span class="token string">"https://maindrillapp.com/api/1.0/messages/send""</span>

<span class="token keyword">type</span> MailChimp <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	apiKey     <span class="token builtin">string</span>
	from       <span class="token builtin">string</span>
	httpClient http<span class="token punctuation">.</span>Client
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> MailChimpReqBody <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Key     <span class="token builtin">string</span> <span class="token string">&#96;json:"key"&#96;</span>
	Message <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
		FromEmail <span class="token builtin">string</span> <span class="token string">&#96;json:"from_email"&#96;</span>
		Subject   <span class="token builtin">string</span> <span class="token string">&#96;json:"subject"&#96;</span>
		Text      <span class="token builtin">string</span> <span class="token string">&#96;json:"text"&#96;</span>
		To        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
			Email <span class="token builtin">string</span> <span class="token string">&#96;json:"email"&#96;</span>
			Type  <span class="token builtin">string</span> <span class="token string">&#96;json:"type"&#96;</span>
		<span class="token punctuation">&#125;</span> <span class="token string">&#96;json:"to"&#96;</span>
	<span class="token punctuation">&#125;</span> <span class="token string">&#96;json:"message"&#96;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">NewMailChimp</span><span class="token punctuation">(</span>apiKey <span class="token builtin">string</span><span class="token punctuation">,</span> from <span class="token builtin">string</span><span class="token punctuation">,</span> httpClient http<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token operator">*</span>MailChimp <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>MailChimp<span class="token punctuation">&#123;</span>
		apiKey<span class="token punctuation">:</span>     apiKey<span class="token punctuation">,</span>
		from<span class="token punctuation">:</span>       from<span class="token punctuation">,</span>
		httpClient<span class="token punctuation">:</span> httpClient<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m MailChimp<span class="token punctuation">)</span> <span class="token function">SendEmail</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> to <span class="token builtin">string</span><span class="token punctuation">,</span> title <span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	mailBody <span class="token operator">:=</span> MailChimpReqBody<span class="token punctuation">&#123;</span>
		Key<span class="token punctuation">:</span> m<span class="token punctuation">.</span>apiKey<span class="token punctuation">,</span>
		Message<span class="token punctuation">:</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
			FromEmail <span class="token builtin">string</span> <span class="token string">&#96;json:"from_email"&#96;</span>
			Subject   <span class="token builtin">string</span> <span class="token string">&#96;json:"subject"&#96;</span>
			Text      <span class="token builtin">string</span> <span class="token string">&#96;json:"text"&#96;</span>
			To        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
				Email <span class="token builtin">string</span> <span class="token string">&#96;json:"email"&#96;</span>
				Type  <span class="token builtin">string</span> <span class="token string">&#96;json:"type"&#96;</span>
			<span class="token punctuation">&#125;</span> <span class="token string">&#96;json:"to"&#96;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>
			FromEmail<span class="token punctuation">:</span> m<span class="token punctuation">.</span>from<span class="token punctuation">,</span>
			Subject<span class="token punctuation">:</span>   title<span class="token punctuation">,</span>
			Text<span class="token punctuation">:</span>      body<span class="token punctuation">,</span>
			To<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
				Email <span class="token builtin">string</span> <span class="token string">&#96;json:"email"&#96;</span>
				Type  <span class="token builtin">string</span> <span class="token string">&#96;json:"type"&#96;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Email<span class="token punctuation">:</span> to<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> <span class="token string">"to"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>

	payload<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>mailBody<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to marshall body: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span> emailUrl<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create request: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> m<span class="token punctuation">.</span>httpClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to send email: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>이와 같이 인프라스트럭처 레이어를 구성하면, 애플리케이션 서비스에서 다음과 같이 사용할 수 있다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">type</span> BookingAppService <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	bookingRepo          BookingRepository
	bookingDomainService BookingDomainService
	emailService         EmailSender
<span class="token punctuation">&#125;</span>

<span class="token operator">...</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>BookingAppService<span class="token punctuation">)</span> <span class="token function">CreateBooking</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> booking Booking<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	u<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>accountCtxKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>chapter2<span class="token punctuation">.</span>Customer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid customer"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> u<span class="token punctuation">.</span><span class="token function">UserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> booking<span class="token punctuation">.</span>userId<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"cannot create booking for other users"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	err <span class="token operator">:=</span> b<span class="token punctuation">.</span>bookingDomainService<span class="token punctuation">.</span><span class="token function">CreateBooking</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> booking<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not create booking: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	err <span class="token operator">=</span> b<span class="token punctuation">.</span>bookingRepo<span class="token punctuation">.</span><span class="token function">SaveBooking</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> booking<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"could not save bookign: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	err <span class="token operator">=</span> b<span class="token punctuation">.</span>emailService<span class="token punctuation">.</span><span class="token function">SendEmail</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p>이제 애플리케이션 서비스의 <code>CreateBooking</code> 함수가 호출되면 예약을 생성하고, 데이터베이스에 저장하는 것 뿐만 아니라 이메일을 유저에게 보낼 것이다.</p> <br/><br/> <h2 id="references"><a aria-hidden="true" tabindex="-1" href="#references"><span class="icon icon-link"></span></a>References</h2> <hr/> <center><p>[</p> <img src="https://learning.oreilly.com/covers/urn:orm:book:9781804613450/400w/" alt="Domain-Driven Design with Golang Cover" loading="lazy"/><!----> ](https://learning.oreilly.com/library/view/domain-driven-design-with/9781804613450/) <br/> [Matthew Boyle, Domain-Driven Design with Golang』, O'Reilly Media, Inc.](https://learning.oreilly.com/library/view/domain-driven-design-with/9781804613450/)</center><!----> <!--[--><aside class="post-footer"><h2>Posted in:</h2> <ul><!--[--><li><a href="/category/Golang/">Golang</a></li><li><a href="/category/Backend/">Backend</a></li><li><a href="/category/Architecture/">Architecture</a></li><li><a href="/category/Domain Driven Design/">Domain Driven Design</a></li><!--]--></ul></aside><!--]--></article> <!--[--><!--[!--><!--]--><!--]--><!----><!----></div><!----> <footer><p>© 2026 JHSeo</p></footer><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_16dfua8 = {
						base: new URL("../../../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../../../_app/immutable/entry/start.J4futHBO.js"),
						import("../../../../_app/immutable/entry/app.BUVMy7h9.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 12],
							data: [{type:"data",data:null,uses:{}},null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
