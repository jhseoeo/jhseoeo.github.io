<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		
		<link href="../../../../_app/immutable/assets/0.bf7b65b6.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/IconBase.6bf551a2.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/start.bd2ebf78.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/index.d78780bf.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/singletons.67de6236.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/index.53878e7f.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/control.f5b05b5f.js">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/app.a9763b0a.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/preload-helper.41c905a7.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/0.bad5160c.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/config.30afbbb8.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/store.8bff042e.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/index.96cef4e6.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/13.950430c7.js"><title>AWS Lambda 함수를 Golang으로 작성할 때 알아두면 좋은 것들</title><!-- HEAD_svelte-ovibev_START --><meta data-key="description" name="description" content="AWS Lambda Golang으로 함수를 만들어 보며 알게 된 것들"><meta property="og:type" content="article"><meta property="og:title" content="AWS Lambda 함수를 Golang으로 작성할 때 알아두면 좋은 것들"><meta property="og:description" content="AWS Lambda Golang으로 함수를 만들어 보며 알게 된 것들"><meta property="og:image" content="https://jhseoeo.github.io//post_img/Cloud/AWS/Lambda_with_Golang/cover.png"><meta property="og:image:width" content="16"><meta property="og:image:height" content="9"><!-- HEAD_svelte-ovibev_END -->
		<!-- You can replace this block to update the Google fonts used in the project -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			rel="preload"
			href="https://fonts.googleapis.com/css2?&family=Nanum+Gothic&family=Jua&family=Source+Code+Pro:wght@400&display=swap"
			as="style"
			onload="this.onload=null;this.rel='stylesheet'"
		/>
		<noscript>
			<link
				href="https://fonts.googleapis.com/css2?&family=Nanum+Gothic&family=Jua&family=Source+Code+Pro:wght@400&display=swap"
				rel="stylesheet"
			/>
		</noscript>

		<!-- End Google Fonts block -->
		<meta name="google-site-verification" content="kTz5xeug4vOcZSULbtGzj4xjmF8AxGtxARj8vCKoVOA" />
		<!-- You can add global <meta> tags here, but anything not global or dynamic should be a `<svelte:head>` tag on the proper page(s) instead. -->
	</head>
	<body>
		<div id="svelte">






<div class="layout"><header><a class="skip-to-content-link" href="#main">Skip to main content
	</a>

	
<nav class="main-nav"><ul><li><a href="/posts" aria-current="page" class="active">Posts
			</a></li><li><a href="/category" aria-current="false">Categories
			</a></li><li><a href="/about" aria-current="false">About
			</a></li><li><a href="/learning" aria-current="false">Learning
			</a></li><li><a href="/api/rss.xml" aria-current="false">RSS
			</a></li><li><a href="/#" aria-current="false">Home
			</a></li></ul>
	<button aria-pressed="false" class="menu-button" tabindex="-1"><span class="sr-only">Toggle hamburger menu</span>
	<svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M64,48.496l-48.496,-48.496l-15.504,15.504l48.496,48.496l-48.496,48.496l15.504,15.504l48.496,-48.496l48.496,48.496l15.504,-15.504l-48.496,-48.496l48.496,-48.496l-15.504,-15.504l-48.496,48.496Z"></path></svg></button></nav>
	<button aria-pressed="false" class="menu-button" tabindex="0"><span class="sr-only">Toggle hamburger menu</span>
	<svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><rect x="0" y="12.48" width="128" height="18.688"></rect></g><g><rect x="0" y="96.832" width="128" height="18.688"></rect></g><g><rect x="0" y="54.656" width="128" height="18.688"></rect></g></svg></button>

	<a href="/" class="site-title">집밥서선생</a>

	<button class="toggle-theme">☀️</button></header>
	<main id="main" tabindex="-1"><div class="content">




<article class="post">
	<img class="cover-image" src="/post_img/Cloud/AWS/Lambda_with_Golang/cover.png" alt="" style="aspect-ratio: 16 / 9;" width="16" height="9">

	<h1>AWS Lambda 함수를 Golang으로 작성할 때 알아두면 좋은 것들</h1>

	<div class="meta"><b>Published:</b>
		2023-10-23</div>

	<p>개인프로젝트를 하며 Lambda를 쓰게 되었고, 열심히 공부한 Golang으로 작성하게 되었다. 그 과정에서 겪은 여러 시행착오와 알게 된 것들을 정리해보려고 한다.</p>
<h2 id="handler-함수의-signature"><a aria-hidden="true" tabindex="-1" href="#handler-함수의-signature"><span class="icon icon-link"></span></a>Handler 함수의 signature</h2>
<hr>
<p>Lambda 함수를 작성할 때, Handler 함수의 유효한 signature는 몇 가지가 있다.</p>
<pre class="language-go"><!-- HTML_TAG_START --><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>TIn<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> TIn<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>TOut<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>TOut<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> TIn<span class="token punctuation">)</span> <span class="token punctuation">(</span>TOut<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></code><!-- HTML_TAG_END --></pre>
<p>위 signature는 모두 유효한 형태이다. <code>func (context.Context, TIn) (TOut, error)</code>의 형태가 가장 이상적인 형태라고 볼 수 있다.</p>
<p>이 때 <code>TIn</code>과 <code>TOut</code>은 Lambda 함수의 event 및 response의 타입을 의미하며, 입력 및 출력 값이 알아서 unmarshal 및 marshal 된다.</p>
<p>event로 어떤 데이터가 올지 모르는 경우 <code>interface{}</code>로 놓을 수 있다. 이 때는 <code>map[string]interface{}</code>로 unmarshal 되는데, 데이터 구조를 대략적으로 확인할 수 있다.
거기다가 ChatGPT한테 golang struct 형태로 바꿔달라 하면 바꿔준다!</p>
<p><img src="/post_img/Cloud/AWS/Lambda_with_Golang/1.png" alt="사진"></p>
<p>오오 GPT는 신이야</p>
<br>
<p>한편 Lambda 함수의 Invoke 조건을 API Gateway로 한 경우 Response의 데이터타입은 <code>interface{}</code>로 놓을 수 없다.
이게 Invoke 조건이 다를 때는 어떤지 잘 모르겠는데, API Gateway로 Invoke할 때는
Response 타입이 <code>interface{}</code>이면 Lambda 함수가 실행되지 않는다. 이 때 로그상에 아무런 에러 메시지도 뜨지 않기 때문에 찾기가 힘들다.</p>
<p>나의 경우 Golang이 Polymorphism을 지원하지 않고, 리턴 타입에 제네릭을 끼워넣기도 애매해서 핸들러의 리턴 타입을 <code>interface{}</code>로 뒀었는데 갑자기 안됐었다.
이거 때문인 줄도 모르고 한참을 해맸다 ㅂㄷㅂㄷ..</p>
<br><br>
<h2 id="코드-중복을-줄이기-위한-패키지-구조"><a aria-hidden="true" tabindex="-1" href="#코드-중복을-줄이기-위한-패키지-구조"><span class="icon icon-link"></span></a>코드 중복을 줄이기 위한 패키지 구조</h2>
<hr>
<p>API Gateway와 연결된 Lambda 함수의 경우, endpoint 및 method당 한 개의 Lambda 함수를 만드는 것이 일반적이다.
그 외에도 cronjob이나 S3 event 등 여러 용도와 목적으로 Lambda 함수가 만들어지다 보면 Lambda 함수의 개수가 꽤 많아질 수 있다.</p>
<p>이 때 코드를 재활용하지 않고 각 Lambda 함수를 작성하면 코드가 엄청나게 중복된다.
이를 방지하기 위해 코드를 재활용할 수 있는 패키지 구조는 다음과 같다.</p>
<pre class="language-text"><!-- HTML_TAG_START --><code class="language-text">.
├── build
├── internal
│   ├── application
│   │   └── ...
│   ├── cmd
│   │   ├── Function-A
│   │   │   ├── main.go
│   │   │   └── main_test.go
│   │   ├── Function-B
│   │   │   ├── main.go
│   │   │   └── main_test.go
│   │   └── Function-C
│   │       ├── main.go
│   │       └── main_test.go
│   ├── domain
│   │   ├── model
│   │   └── service
│   ├── infrastructure
│   │   └── ...
│   └── interface
│       ├── dto
│       │   ├── request
│       │   └── response
│       └── handler
├── scripts
│   ├── deploy.sh
│   └── ...
├── go.mod
├── go.sum
├── .gitignore
└── ...</code><!-- HTML_TAG_END --></pre>
<p><em>cmd</em> 폴더 외에는 모두 DDD(Domain Driven Design) 패턴의 구조를 따른다.
cmd 폴더 안에는 각 Lambda 함수의 main 함수가 작성되어 있으며, 의존성 주입을 통해 각 Lambda 함수의 동작이 결정되기 때문에 코드 중복을 줄일 수 있다.</p>
<p>아마 다른 마이크로서비스 아키텍처에서도 비슷한 패턴을 사용할 수 있을 것이다.</p>
<br><br>
<h2 id="빌드-및-배포"><a aria-hidden="true" tabindex="-1" href="#빌드-및-배포"><span class="icon icon-link"></span></a>빌드 및 배포</h2>
<hr>
<p>Lambda 함수가 많아진다는 것은 빌드 및 배포를 해야 할 대상이 많아진다는 것을 의미한다.
일일이 명령어를 하나씩 입력해가며 빌드 및 배포 과정을 거치는 것은 매우 비효율적이다.
위의 디렉토리 구조를 사용한다고 가정하고, 간단한 쉘 스크립트를 작성하여 빌드 및 배포 과정을 명령어 한 줄로 실행할 수 있도록 하자.</p>
<pre class="language-sh"><!-- HTML_TAG_START --><code class="language-sh"><span class="token comment"># 파라미터 체크</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> &lt;function name>"</span>
  <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment"># 변수 설정</span>
<span class="token assign-left variable">PROJECT_DIR</span><span class="token operator">=</span><span class="token string">"$(cd "<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">"<span class="token variable">$0</span>"</span><span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span><span class="token punctuation">)</span>/<span class="token punctuation">..</span><span class="token string">"
FUNCTION_NAME="</span><span class="token variable">$1</span><span class="token string">"
LAMBDA_NAME="</span><span class="token variable">$FUNCTION_NAME</span><span class="token string">"
BIN_FILE="</span><span class="token variable">$PROJECT_DIR</span>/build/<span class="token variable">$FUNCTION_NAME</span><span class="token string">"
ZIP_FILE="</span><span class="token variable">$PROJECT_DIR</span>/build/function-<span class="token variable">$FUNCTION_NAME</span>.zip<span class="token string">"
PROFILE="</span><span class="token comment">#</span><span class="token comment">#프로필##"</span>

<span class="token comment"># 디렉토리명(함수명) 검사</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/internal/cmd/<span class="token variable">$FUNCTION_NAME</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"The directory '<span class="token variable">$FUNCTION_NAME</span>' does not exist."</span>
  <span class="token builtin class-name">return</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment"># 빌드</span>
<span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>"</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$BIN_FILE</span>"</span> <span class="token string">"<span class="token variable">$ZIP_FILE</span>"</span>
<span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux <span class="token assign-left variable">GOARCH</span><span class="token operator">=</span>amd64 <span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span> go build <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/build/<span class="token variable">$FUNCTION_NAME</span>"</span> <span class="token parameter variable">-C</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/internal/cmd/<span class="token variable">$FUNCTION_NAME</span>"</span> <span class="token string">"./..."</span>
<span class="token function">mv</span> <span class="token string">"<span class="token variable">$BIN_FILE</span>"</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/build/main"</span>
<span class="token function">zip</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-j</span> <span class="token string">"<span class="token variable">$ZIP_FILE</span>"</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/build/main"</span>
<span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$PROJECT_DIR</span>/build/main"</span>
aws lambda update-function-code <span class="token punctuation"></span>
    --function-name <span class="token string">"<span class="token variable">$LAMBDA_NAME</span>"</span> <span class="token punctuation"></span>
    --zip-file <span class="token string">"fileb://<span class="token variable">$ZIP_FILE</span>"</span> <span class="token punctuation"></span>
    <span class="token parameter variable">--profile</span> <span class="token variable">$PROFILE</span></code><!-- HTML_TAG_END --></pre>
<p>예를 들어 <em>Function-A</em>라는 Lambda 함수를 빌드 및 배포하고 싶다면, 다음과 같이 실행하면 된다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">./scripts/deploy.sh Function-A</code><!-- HTML_TAG_END --></pre>

	<aside class="post-footer"><h2>Posted in:</h2>
			<ul><li><a href="/category/AWS Lambda/">AWS Lambda</a>
					</li><li><a href="/category/Golang/">Golang</a>
					</li></ul></aside></article>

</div>
		<footer><p>© 2023 JHSeo. All right reserved.</p></footer></main></div>


			
			<script>
				{
					__sveltekit_tibwb7 = {
						base: new URL("../../../..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [{"type":"data","data":null,"uses":{}},{"type":"data","data":{params:{post:"Cloud/AWS/Lambda with Golang"}},"uses":{"params":["post","then",null]}}];

					Promise.all([
						import("../../../../_app/immutable/entry/start.bd2ebf78.js"),
						import("../../../../_app/immutable/entry/app.a9763b0a.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 13],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
