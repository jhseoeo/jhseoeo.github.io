<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		
		<link href="../../../../_app/immutable/assets/0.CWEFMGw7.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/CodeBlockWrapper.DOA6KAmR.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/start.CrgTm98e.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Bk9At9BS.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CVx5jffJ.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DIeogL5L.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DMgF1Uhx.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D0iwhpLH.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/ByF348JK.js">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/app.C6SNZHYJ.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D_kqQSo5.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/2cXyNWGb.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Bzak7iHL.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Ca2j7qFz.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/BmVC6lTd.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/BnZK2-eX.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/C0t2u1D1.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/0.m3z0EiTz.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D7leeM5l.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DKQVeb5P.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CP-r3QU3.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Bp7YhWCs.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DkPbIObf.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/69_IOA4Y.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/D2vXKg8d.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DJh_0fka.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/Dg0EvQHI.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/12.C4qnNUYQ.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/DF2T1Nhr.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/CxRPdVhl.js"><!--1y1qu0s--><meta data-key="description" name="description" content="아토믹 메모리 오퍼레이션에 대해 알아보자"/> <meta property="og:type" content="article"/> <meta property="og:title" content="아토믹 메모리 오퍼레이션"/> <meta property="og:description" content="아토믹 메모리 오퍼레이션에 대해 알아보자"/><!----><title>아토믹 메모리 오퍼레이션</title>
		<!-- You can replace this block to update the Google fonts used in the project -->
		<!-- <link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css"
		/>
		<link
			href="https://fonts.googleapis.com/css2?&family=Nanum+Gothic&family=Jua&family=Source+Code+Pro:wght@400&display=swap"
			rel="stylesheet"
		/>

		<!-- End Google Fonts block -->

		<!-- You can add global <meta> tags here, but anything not global or dynamic should be a `<svelte:head>` tag on the proper page(s) instead. -->
	</head>
	<body>
		<div id="svelte"><!--[--><!--[--><!----><div class="layout"><header><a class="skip-to-content-link" href="#main">Skip to main content</a> <nav class="main-nav"><ul><!--[--><li><a href="/posts" aria-current="false"><!---->Posts<!----></a></li><li><a href="/category" aria-current="false"><!---->Categories<!----></a></li><li><a href="/about" aria-current="false"><!---->About<!----></a></li><li><a href="/api/rss.xml" aria-current="false"><!---->RSS<!----></a></li><li><a href="/#" aria-current="false"><!---->Home<!----></a></li><!--]--></ul> <button aria-pressed="false" class="menu-button" tabindex="-1"><span class="sr-only">Toggle hamburger menu</span> <!--[--><svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M64,48.496l-48.496,-48.496l-15.504,15.504l48.496,48.496l-48.496,48.496l15.504,15.504l48.496,-48.496l48.496,48.496l15.504,-15.504l-48.496,-48.496l48.496,-48.496l-15.504,-15.504l-48.496,48.496Z"></path></svg><!--]--></button><!----></nav><!----> <button aria-pressed="false" class="menu-button" tabindex="0"><span class="sr-only">Toggle hamburger menu</span> <!--[!--><svg viewBox="0 0 128 128" version="1.1" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><rect x="0" y="12.48" width="128" height="18.688"></rect></g><g><rect x="0" y="96.832" width="128" height="18.688"></rect></g><g><rect x="0" y="54.656" width="128" height="18.688"></rect></g></svg><!--]--></button><!----> <a href="/" class="site-title">집밥서선생</a> <button class="toggle-theme"><!--[-->☀️<!--]--></button><!----></header><!----> <main id="main" tabindex="-1"><!----><div class="content"><!----><article class="post"><img class="cover-image" src="/post_img/Go/Concurrency in Go/cover.png" alt="" style="aspect-ratio: 16 / 9;" width="16" height="9"/> <h1>아토믹 메모리 오퍼레이션</h1> <div class="meta"><b>Published:</b> 2023-10-01</div> <!----><h2 id="memory-guarantees"><a aria-hidden="true" tabindex="-1" href="#memory-guarantees"><span class="icon icon-link"></span></a>Memory Guarantees</h2> <hr/> <p>Go에서 mutex등을 사용했을 때 병목 현상이 일어나는 경우, 이를 atomic 연산으로 대체하여 일부 해결할 수 있다.</p> <p>Go의 메모리 모델은 word size보다 작은 변수의 write 연산에 대해 원자성을 보장하지만, 해당 연산의 효과를 다른 고루틴에서 볼 수 있는지에 대한 보장은 하지 않는다.
이전에도 언급했듯 컴파일러와 CPU는 코드의 실행순서를 최적화하거나 메모리 연산을 재배치할 수 있기 때문이다.</p> <p>하지만 다른 고루틴에서 해당 변수의 값을 읽을 때, 해당 고루틴이 write한 값을 읽을 수도 있고, 이전에 write한 값을 읽을 수도 있지만, 무작위한 값을 읽지 않도록 보장해준다.
한편, word size보다 큰 변수의 write 연산에 대해서는 원자성을 보장하지 않는다. 이로 인해 예상치 못한 결과가 발생할 수 있다.</p> <p>다음 예제를 보자.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> str <span class="token builtin">string</span>
	<span class="token keyword">var</span> done <span class="token builtin">bool</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		str <span class="token operator">=</span> <span class="token string">"Done!"</span>
		done <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>done <span class="token punctuation">&#123;</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 코드에는 memory race가 존재한다.
이를 실행하면 <em>Done!</em>이 출력되는 것을 기대하지만, 빈 문자열이 출력되거나, 어쩌면 프로그램이 중단될 수도 있다(<code>done</code>에 대한 memory write가 메인 고루틴에서 관측되지 않기 때문).</p> <p>이를 해결하기 위해 Go는 <code>sync/atomic</code> 패키지를 제공한다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> done atomic<span class="token punctuation">.</span>Bool
	<span class="token keyword">var</span> a <span class="token builtin">int</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		a <span class="token operator">=</span> <span class="token number">5</span>
		done<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> done<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>메모리는 atomic 연산에 대한 원자성을 보장한다.
만약 atomic write의 결과가 atomic read에 의해 관측되면, 해당 write 연산은 read 연산 이후에 일어난(atomic write happened before atomic read) 것으로 간주된다.
위 코드는 5를 출력하거나, 아무것도 출력하지 않는다. 하지만 0을 출력하는 경우는 없다.</p> <p>주의할 점은 memory race와 data race는 다르다는 것이다.
위 프로그램의 경우 <code>atomic</code> 패키지를 사용하여 memory race는 해결했지만, 여전히 data race를 가지고 있다.
이러한 점 때문에 <code>atomic</code> 패키지를 사용할 때는 주의해야 한다.</p> <br/><br/> <h2 id="compare-and-swap"><a aria-hidden="true" tabindex="-1" href="#compare-and-swap"><span class="icon icon-link"></span></a>Compare and Swap</h2> <hr/> <p>조건을 검사하고 결과에 따라 동작하는 코드는 race condition을 만들 수 있다.
예를 들면 다음의 코드는 atomic을 사용함에도 mutual exclusion을 보장하지 않는다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">var</span> locked sync<span class="token punctuation">.</span>Bool
<span class="token keyword">func</span> <span class="token function">wrongCriticalSectionExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>locked<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    locked<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> locked<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>이 함수는 <code>locked</code>가 <code>false</code>일 때만 critical section에 들어가고, critical section을 빠져나올 때 <code>locked</code>를 <code>false</code>로 바꾼다.
하지만 두 고루틴이 동시에 <code>locked.Load()</code>를 호출하고, 두 고루틴이 <code>false</code>를 읽은 후에 <code>true</code>를 쓰면, 두 고루틴 모두 critical section에 들어가게 된다.</p> <p>따라서 비교 및 저장 작업을 하나의 atomic 연산으로 수행해야 하며, 이를 compare-and-swap(CAS)이라고 한다.
예제를 통해 사용 방법을 살펴보자.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">criticalSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> locked<span class="token punctuation">.</span><span class="token function">CompareAndSwap</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">defer</span> locked<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 예제에서 <code>locked</code>가 <code>false</code>일 때만 critical section에 들어가고, <code>locked</code>의 값을 <code>true</code>로 바꾼다. 그리고 critical section을 빠져나올 때 <code>locked</code>를 <code>false</code>로 바꾼다.
또한 <code>locked</code>가 <code>true</code>일 때는 critical section에 들어가지 않는다.</p> <p>CAS를 통해 Mutex의 TryLock을 대체할 수 있다.</p> <br/><br/> <h2 id="atomic의-실제-사용"><a aria-hidden="true" tabindex="-1" href="#atomic의-실제-사용"><span class="icon icon-link"></span></a>Atomic의 실제 사용</h2> <hr/> <p>atomic operation이 사용된 몇 가지 예제를 살펴보자.</p> <h3 id="카운터"><a aria-hidden="true" tabindex="-1" href="#카운터"><span class="icon icon-link"></span></a>카운터</h3> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> count <span class="token builtin">int64</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
		<span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">10000</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 코드에서 write 연산에 대한 memory race가 존재하지 않기 때문에 <code>count</code>의 값은 반드시 10000이 된다.
따라서 실행 결과는 (race condition은 존재하기 때문에) 매번 달라지지만, 가장 마지막에는 반드시 10000이 출력되고 프로그램이 종료될 것이다.</p> <br/> <h3 id="heartbeat-및-progress-indicator"><a aria-hidden="true" tabindex="-1" href="#heartbeat-및-progress-indicator"><span class="icon icon-link"></span></a>Heartbeat 및 Progress Indicator</h3> <p>고루틴의 Heartbeat 및 진행 상황을 표시하는 데에도 atomic을 사용할 수 있다.
이 때 shared variable 및 mutex를 사용하지 않기 때문에 추가적인 동기화 없이 여러 고루틴에서 사용할 수 있다는 장점이 있다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">type</span> ProgressMeter <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	progress  <span class="token builtin">int64</span>
	timestamp <span class="token builtin">int64</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProgressMeter<span class="token punctuation">)</span> <span class="token function">Progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pm<span class="token punctuation">.</span>progress<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pm<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProgressMeter<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pm<span class="token punctuation">.</span>progress<span class="token punctuation">)</span><span class="token punctuation">,</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pm<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 예제의 <code>ProgressMeter</code>는 <code>Progress()</code> 메서드를 통해 진행 상황을 업데이트하고, <code>Get()</code> 메서드를 통해 진행 상황을 가져온다.
이 때 메서드 안의 atomic 연산의 원자성이 보장되는 것이지, 메서드 자체의 원자성은 보장되지 않기 때문에 올바르게 구현하려면 뮤텍스 등을 사용하는 것이 좋다.</p> <br/> <p>해당 <code>ProgressMeter</code>를 사용하는 예제는 다음과 같다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">longGoroutine</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pm <span class="token operator">*</span>ProgressMeter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Context cancelled"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		pm<span class="token punctuation">.</span><span class="token function">Progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 고루틴은 0~120ms 사이의 랜덤한 시간 동안 대기한 후 <code>Progress()</code>를 호출하여 진행 상황을 업데이트한다.</p> <div class="codeBlockWrapper closed svelte-13tv1p3"><div class="svelte-13tv1p3"><!--[--><pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">observer</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cancel <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> progress <span class="token operator">*</span>ProgressMeter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tick <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> tick<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> lastProgress <span class="token builtin">int64</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>tick<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			p<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> progress<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> p <span class="token operator">==</span> lastProgress <span class="token punctuation">&#123;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"No progress in the last 100ms"</span><span class="token punctuation">)</span>
				<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				lastProgress <span class="token operator">=</span> p
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Progress:"</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!----></pre><!--]--></div> <!--[!--><!--]--> <!--[!--><!--]-->  <!--[!--><div class="btn openBtn svelte-13tv1p3">Show⯆</div><!--]--></div><!----> <p><code>observer</code> 고루틴은 100밀리초마다 <code>ProgressMeter</code>의 진행 상황을 가져와서 이전 진행 상황과 비교한다.
만약 진행 상황이 업데이트되지 않았다면, <code>cancel()</code>을 호출하여 <code>longGoroutine</code>을 종료시킨다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> progress ProgressMeter
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">longGoroutine</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>progress<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">observer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> <span class="token operator">&amp;</span>progress<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 코드를 실행하면 <code>longGoroutine</code>이 진행 상황을 업데이트하고, <code>observer</code>가 진행 상황을 확인한다.
만약 <code>longGoroutine</code>이 100밀리초마다 진행 상황을 업데이트하지 않으면 <code>observer</code>가 <code>longGoroutine</code>을 종료시킨다.</p> <br/> <h3 id="취소"><a aria-hidden="true" tabindex="-1" href="#취소"><span class="icon icon-link"></span></a>취소</h3> <p>채널을 통해 취소시키는 건 이미 알고 있지만, atomic을 사용하여 취소시키는 방법도 있다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">CancelSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cancel <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isCancelled <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span>Bool<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	cancel <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		v<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	isCancelled <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>위 코드는 <code>cancel</code> 함수를 호출하면 <code>isCancelled</code> 함수가 <code>true</code>를 반환하도록 한다. 이를 통해 다음과 같이 취소 여부를 확인할 수 있다.
Go가 아닌 다른 언어에서는 이런 식으로 취소 여부를 확인하는 경우가 많은데, Go에서는 채널을 통해 취소하는 것이 더 좋은 방법인 것 같다.</p> <pre class="language-go"><!----><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cancel<span class="token punctuation">,</span> isCancelled <span class="token operator">:=</span> <span class="token function">CancelSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cancelled"</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <br/><br/> <h2 id="references"><a aria-hidden="true" tabindex="-1" href="#references"><span class="icon icon-link"></span></a>References</h2> <hr/> <center><p>[</p> <img src="https://learning.oreilly.com/covers/urn:orm:book:9781804619070/400w/" alt="Effective Concurrency in Go" loading="lazy"/><!----> ](https://learning.oreilly.com/library/view/effective-concurrency-in/9781804619070/)<br/> [Burak Serdar, 『Effective Concurrency in Go』, Packt Publishing](https://learning.oreilly.com/library/view/effective-concurrency-in/9781804619070/)</center><!----> <!--[--><aside class="post-footer"><h2>Posted in:</h2> <ul><!--[--><li><a href="/category/Golang/">Golang</a></li><li><a href="/category/Concurrency in Go/">Concurrency in Go</a></li><!--]--></ul></aside><!--]--></article> <!--[--><!--[!--><!--]--><!--]--><!----><!----></div><!----> <footer><p>© 2026 JHSeo</p></footer><!----></main></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_6ptnqs = {
						base: new URL("../../../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../../../_app/immutable/entry/start.CrgTm98e.js"),
						import("../../../../_app/immutable/entry/app.C6SNZHYJ.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 12],
							data: [{type:"data",data:null,uses:{}},null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
